<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MoodMap Game</title>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<!-- Leaflet f체r Karte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f4f8; }
  #menu { background:#4CAF50; color:white; padding:10px; text-align:center; }
  #menu button { margin:5px; padding:10px; border:none; border-radius:5px; cursor:pointer; }
  #map { height:60vh; width:100%; margin-top:10px; border:2px solid #ccc; border-radius:10px; }
  #loginForm, #signupForm { display:none; max-width:300px; margin:20px auto; padding:20px; border:1px solid #ccc; border-radius:10px; background:white; }
  input { width:100%; margin:5px 0; padding:10px; border-radius:5px; border:1px solid #ccc; }
  #status { text-align:center; margin:10px; }
</style>
</head>
<body>

<div id="menu">
  <span id="usernameDisplay">Nicht angemeldet</span>
  <button onclick="showLogin()">Login</button>
  <button onclick="showSignup()">Signup</button>
  <button onclick="logout()">Logout</button>
  <button onclick="changeColor()">Farben 채ndern</button>
</div>

<div id="loginForm">
  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Passwort">
  <button onclick="login()">Login</button>
</div>

<div id="signupForm">
  <h3>Signup</h3>
  <input type="text" id="signupName" placeholder="Name">
  <input type="email" id="signupEmail" placeholder="Email">
  <input type="password" id="signupPassword" placeholder="Passwort">
  <button onclick="signup()">Registrieren</button>
</div>

<div id="status">Standort wird noch nicht ermittelt...</div>
<div id="map"></div>

<script>
  // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDAnL8GOSj9LOE0FHWWuJG5Kkc6-AByNlo",
  authDomain: "mood-map100.firebaseapp.com",
  projectId: "mood-map100",
  storageBucket: "mood-map100.firebasestorage.app",
  messagingSenderId: "840085816046",
  appId: "1:840085816046:web:56a1673b20edf81c47a9ff",
  measurementId: "G-82J01KP764"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let map;
  let userMarker;

  // Karten-Initialisierung
  function initMap() {
    map = L.map('map').setView([51.1657, 10.4515], 6); // Start Deutschland
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  }

  initMap();

  // Standort ermitteln
  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Du bist hier").openPopup();
        map.setView([lat, lon], 13);
        document.getElementById('status').innerText = `Standort: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        // Speichern im Firebase DB
        const user = auth.currentUser;
        if(user) {
          db.ref('users/' + user.uid + '/location').set({lat, lon});
        }
      }, () => {
        document.getElementById('status').innerText = "Standort konnte nicht ermittelt werden.";
      });
    } else {
      document.getElementById('status').innerText = "Geolocation wird von diesem Browser nicht unterst체tzt.";
    }
  }

  // Login/Signup/Logout
  function showLogin() { document.getElementById('loginForm').style.display='block'; document.getElementById('signupForm').style.display='none'; }
  function showSignup() { document.getElementById('signupForm').style.display='block'; document.getElementById('loginForm').style.display='none'; }

  function signup() {
    const name = document.getElementById('signupName').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    auth.createUserWithEmailAndPassword(email, password).then(cred => {
      db.ref('users/' + cred.user.uid).set({name, level:1});
      document.getElementById('usernameDisplay').innerText = name;
      getLocation();
    }).catch(err => alert(err.message));
  }

  function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(email, password).then(cred => {
      db.ref('users/' + cred.user.uid + '/name').once('value').then(snap => {
        document.getElementById('usernameDisplay').innerText = snap.val();
      });
      getLocation();
    }).catch(err => alert(err.message));
  }

  function logout() {
    auth.signOut();
    document.getElementById('usernameDisplay').innerText = "Nicht angemeldet";
    document.getElementById('status').innerText = "Standort wird noch nicht ermittelt...";
    if(userMarker) map.removeLayer(userMarker);
  }

  // Farben 채ndern
  const colors = ["#4CAF50", "#FF5722", "#2196F3", "#9C27B0", "#FFC107"];
  let colorIndex = 0;
  function changeColor() {
    colorIndex = (colorIndex + 1) % colors.length;
    document.getElementById('menu').style.background = colors[colorIndex];
  }

  // Auth state listener
  auth.onAuthStateChanged(user => {
    if(user){
      db.ref('users/' + user.uid + '/name').once('value').then(snap => {
        document.getElementById('usernameDisplay').innerText = snap.val();
      });
      getLocation();
    }
  });
</script>

</body>
</html>